var mongo = require('mongodb')
  , config = require('../../../config')[process.env['NODE_ENV'] || 'development']
  , Routes = require('./routes')
  , _ = require('underscore')
  , Q = require('q')
  , db = mongo.Db
  , server = mongo.Server
  ;

function Mongo (opts) {
  var self = this;
  self.opts = opts || {};
  self.Routes = Routes(self.opts);

  self.mongoServer = new server(config.mongoHost, config.mongoPort, {auto_reconnect: true, poolSize: 4});
  self.dataBase = new db('noName', self.mongoServer);

  return this;
};


Mongo.prototype.all = function all () {
  var self = this
    , deferred = Q.defer()
    , results = []
    ;

  self.dataBase.open(function(err, db) {
    self.dataBase.admin(function(err, adminDb) {
      adminDb.listDatabases(function(err, dbs) {

        _.each(dbs.databases, function (indiv) {
          results.push(indiv);
        });

        deferred.resolve(results);

        db.close();
      });
    });
  });

  return deferred.promise;
}

module.exports = function (opts) {
  return new Mongo(opts);
};